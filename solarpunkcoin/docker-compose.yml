# SolarPunkCoin - Docker Compose Configuration
# ==============================================
#
# Quick start:
#   docker-compose up -d
#
# View logs:
#   docker-compose logs -f
#
# Stop all:
#   docker-compose down

version: '3.8'

services:
  # Validator Node 1 (Green Certified)
  validator1:
    build: .
    container_name: spk-validator1
    hostname: validator1
    command: >
      python node/spk_node.py
      --node-id validator1
      --validator
      --stake 10000
      --port 8333
    ports:
      - "8333:8333"  # P2P
      - "8545:8545"  # RPC
    volumes:
      - validator1-data:/data/blockchain
    environment:
      - SPK_NODE_TYPE=validator
      - SPK_GREEN_CERTIFIED=true
      - SPK_NETWORK=testnet
    networks:
      - spk-network
    restart: unless-stopped

  # Validator Node 2 (Green Certified)
  validator2:
    build: .
    container_name: spk-validator2
    hostname: validator2
    command: >
      python node/spk_node.py
      --node-id validator2
      --validator
      --stake 5000
      --port 8334
    ports:
      - "8334:8334"  # P2P
      - "8546:8545"  # RPC
    volumes:
      - validator2-data:/data/blockchain
    environment:
      - SPK_NODE_TYPE=validator
      - SPK_GREEN_CERTIFIED=true
      - SPK_NETWORK=testnet
    networks:
      - spk-network
    restart: unless-stopped
    depends_on:
      - validator1

  # Validator Node 3
  validator3:
    build: .
    container_name: spk-validator3
    hostname: validator3
    command: >
      python node/spk_node.py
      --node-id validator3
      --validator
      --stake 3000
      --port 8335
    ports:
      - "8335:8335"  # P2P
      - "8547:8545"  # RPC
    volumes:
      - validator3-data:/data/blockchain
    environment:
      - SPK_NODE_TYPE=validator
      - SPK_GREEN_CERTIFIED=false
      - SPK_NETWORK=testnet
    networks:
      - spk-network
    restart: unless-stopped
    depends_on:
      - validator1
      - validator2

  # Full Node (Non-validator)
  fullnode:
    build: .
    container_name: spk-fullnode
    hostname: fullnode
    command: >
      python node/spk_node.py
      --node-id fullnode1
      --port 8336
    ports:
      - "8336:8336"  # P2P
      - "8548:8545"  # RPC
    volumes:
      - fullnode-data:/data/blockchain
    environment:
      - SPK_NODE_TYPE=full
      - SPK_NETWORK=testnet
    networks:
      - spk-network
    restart: unless-stopped
    depends_on:
      - validator1

  # Web Dashboard (Streamlit)
  dashboard:
    build: .
    container_name: spk-dashboard
    hostname: dashboard
    command: streamlit run web/dashboard.py --server.port 8501 --server.address 0.0.0.0
    ports:
      - "8501:8501"  # Streamlit UI
    volumes:
      - dashboard-data:/data/blockchain
    environment:
      - SPK_NETWORK=testnet
      - SPK_RPC_ENDPOINT=http://validator1:8545
    networks:
      - spk-network
    restart: unless-stopped
    depends_on:
      - validator1
      - validator2
      - validator3

  # Block Explorer (Web UI)
  explorer:
    build: .
    container_name: spk-explorer
    hostname: explorer
    command: python web/block_explorer.py
    ports:
      - "8080:8080"  # Explorer UI
    environment:
      - SPK_NETWORK=testnet
      - SPK_RPC_ENDPOINT=http://validator1:8545
    networks:
      - spk-network
    restart: unless-stopped
    depends_on:
      - validator1

  # Prometheus (Metrics)
  prometheus:
    image: prom/prometheus:latest
    container_name: spk-prometheus
    hostname: prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    networks:
      - spk-network
    restart: unless-stopped

  # Grafana (Dashboards)
  grafana:
    image: grafana/grafana:latest
    container_name: spk-grafana
    hostname: grafana
    ports:
      - "3000:3000"
    volumes:
      - grafana-data:/var/lib/grafana
      - ./monitoring/grafana-dashboards:/etc/grafana/provisioning/dashboards
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
    networks:
      - spk-network
    restart: unless-stopped
    depends_on:
      - prometheus

networks:
  spk-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

volumes:
  validator1-data:
  validator2-data:
  validator3-data:
  fullnode-data:
  dashboard-data:
  prometheus-data:
  grafana-data:
